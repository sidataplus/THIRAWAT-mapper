name: Publish

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          cache-dependency-glob: |
            pyproject.toml

      - name: Validate publish secrets
        env:
          TESTPYPI_API_TOKEN: ${{ secrets.TESTPYPI_API_TOKEN }}
          PYPI_API_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          if [ -z "${TESTPYPI_API_TOKEN}" ]; then
            echo "Missing TESTPYPI_API_TOKEN secret."
            exit 1
          fi
          if [ -z "${PYPI_API_TOKEN}" ]; then
            echo "Missing PYPI_API_TOKEN secret."
            exit 1
          fi

      - name: Verify tag matches package version
        env:
          TAG: ${{ github.ref_name }}
        run: |
          VERSION="$(
            python - <<'PY'
            import pathlib
            import re
            import sys

            text = pathlib.Path("src/thirawat_mapper/__init__.py").read_text(encoding="utf-8")
            match = re.search(r'__version__\\s*=\\s*"([^"]+)"', text)
            if not match:
              sys.exit("Could not find __version__ in src/thirawat_mapper/__init__.py")
            print(match.group(1))
            PY
          )"
          EXPECTED="v${VERSION}"
          if [ "${TAG}" != "${EXPECTED}" ]; then
            echo "Tag '${TAG}' does not match package version '${VERSION}' (expected '${EXPECTED}')."
            exit 1
          fi

      - name: Install dependencies
        run: uv sync --group dev

      - name: Run tests
        run: uv run pytest

      - name: Install build tools
        run: uv pip install build twine

      - name: Build distributions
        run: uv run python -m build

      - name: Check distributions
        run: uv run python -m twine check dist/*

      - name: Publish to TestPyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.TESTPYPI_API_TOKEN }}
        run: uv run python -m twine upload --skip-existing --repository-url https://test.pypi.org/legacy/ dist/*

      - name: Publish to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: uv run python -m twine upload --skip-existing dist/*

